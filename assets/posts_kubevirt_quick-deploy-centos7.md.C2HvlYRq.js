import{j as s,b as i,c as a,X as n}from"./chunks/framework.8L-hkVlo.js";const c=JSON.parse('{"title":"Kubevirt系列一：虚拟机CentOS 7部署实践","description":"","frontmatter":{"sidebar":false,"cover":"https://cdn.jsdelivr.net/gh/hyperter96/tech-blog/docs/assets/images/aliyun-image-source.png","date":"2023-10-01T00:00:00.000Z","tag":["Kubevirt","虚拟机","kubernetes"],"sticky":1,"next":{"text":"Kubevirt系列二：虚拟机网卡热插拔","link":"/posts/kubevirt/hotplug-interface"}},"headers":[],"relativePath":"posts/kubevirt/quick-deploy-centos7.md","filePath":"posts/kubevirt/quick-deploy-centos7.md","lastUpdated":1711213142000}'),h={name:"posts/kubevirt/quick-deploy-centos7.md"},t=n(`<h1 id="kubevirt系列一-虚拟机centos-7部署实践" tabindex="-1">Kubevirt系列一：虚拟机CentOS 7部署实践 <a class="header-anchor" href="#kubevirt系列一-虚拟机centos-7部署实践" aria-label="Permalink to &quot;Kubevirt系列一：虚拟机CentOS 7部署实践&quot;">​</a></h1><p>俗话说，实践是检验真理的唯一标准，不妨让我们尝试用kubeVirt部署一台属于自己的虚拟机吧~</p><h2 id="准备环境" tabindex="-1">准备环境 <a class="header-anchor" href="#准备环境" aria-label="Permalink to &quot;准备环境&quot;">​</a></h2><p>首先，我们需要安装<code>libvirt</code>和<code>qemu</code>，</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install -y qemu-kvm libvirt virt-install bridge-utils</span></span></code></pre></div><p>查看节点是否支持 kvm 虚拟机化</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> virt-host-validate qemu</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for hardware virtualization                           : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 if device /dev/kvm exists                             : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 if device /dev/kvm is accessible                      : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 if device /dev/vhost-net exists                       : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 if device /dev/net/tun exists                         : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller support                : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;memory&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller mount-point            : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;cpu&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller support                   : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;cpu&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller mount-point               : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;cpuacct&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller support               : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;cpuacct&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller mount-point           : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;cpuset&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller support                : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;cpuset&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller mount-point            : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;devices&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller support               : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;devices&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller mount-point           : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;blkio&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller support                 : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for cgroup &#39;blkio&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controller mount-point             : PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  QEMU:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 正在检查 for device assignment IOMMU support                   : WARN </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">No</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ACPI DMAR table found, IOMMU either disabled in BIOS or not supported by this hardware platform</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>如果不支持，则让 Kubevirt 使用软件虚拟化：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create namespace kubevirt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create configmap -n kubevirt kubevirt-config --from-literal debug.useEmulation=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><p>开始部署最新版本的kubeVirt，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> VERSION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://api.github.com/repos/kubevirt/kubevirt/releases </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;-rc&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> head</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -F</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;: &#39; &#39;{print $2}&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;s/,//&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> xargs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply -f https://github.com/kubevirt/kubevirt/releases/download/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\${VERSION}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/kubevirt-operator.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply -f https://github.com/kubevirt/kubevirt/releases/download/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\${VERSION}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/kubevirt-cr.yaml</span></span></code></pre></div><p>查看命令执行结果</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl get pods -n kubevirt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                               READY   STATUS    RESTARTS      AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virt-api-59d4c5cb49-6b2r2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">82m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">82</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virt-api-59d4c5cb49-d9w4z</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">82m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">82</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virt-controller-8684f9db98-d6w6p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             82</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virt-controller-8684f9db98-hrkjg</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             82</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virt-handler-2hfxz</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             82</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virt-handler-4vk84</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             82</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virt-handler-qg4qt</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             82</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virt-handler-qnzsh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             82</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virt-operator-5fcd4ff76f-47n27</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             84</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virt-operator-5fcd4ff76f-kq4h8</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             84</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m</span></span></code></pre></div><p>接着我们部署CDI，CDI (Containerized Data Importer) 可以使用 PVC 作为 KubeVirt VM 磁盘，建议同时安装：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> VERSION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/kubevirt/containerized-data-importer/releases </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;v[0-9]\\.[0-9]*\\.[0-9]*&quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> head</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create -f https://github.com/kubevirt/containerized-data-importer/releases/download/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$VERSION</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/cdi-operator.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create -f https://github.com/kubevirt/containerized-data-importer/releases/download/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$VERSION</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/cdi-cr.yaml</span></span></code></pre></div><p>安装<code>virtctl</code>工具，virtctl 工具可以直接用来操作虚拟机，执行以下命令下载，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> VERSION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://api.github.com/repos/kubevirt/kubevirt/releases </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;-rc&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> head</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -F</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;: &#39; &#39;{print $2}&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;s/,//&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> xargs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/virtctl https://github.com/kubevirt/kubevirt/releases/download/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$VERSION</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/virtctl-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$VERSION</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">-linux-amd64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x /usr/local/bin/virtctl</span></span></code></pre></div><h2 id="部署虚拟机centos7" tabindex="-1">部署虚拟机CentOS7 <a class="header-anchor" href="#部署虚拟机centos7" aria-label="Permalink to &quot;部署虚拟机CentOS7&quot;">​</a></h2><h3 id="准备系统镜像" tabindex="-1">准备系统镜像 <a class="header-anchor" href="#准备系统镜像" aria-label="Permalink to &quot;准备系统镜像&quot;">​</a></h3><p>下载 CentOS7 镜像，选择阿里云镜像站 <a href="https://mirrors.aliyun.com/centos/7/isos/x86_64/" target="_blank" rel="noreferrer">https://mirrors.aliyun.com/centos/7/isos/x86_64/</a></p><p><img src="https://cdn.jsdelivr.net/gh/hyperter96/tech-blog/docs/assets/images/aliyun-image-source.png" alt="" loading="lazy"></p><h3 id="上传镜像文件" tabindex="-1">上传镜像文件 <a class="header-anchor" href="#上传镜像文件" aria-label="Permalink to &quot;上传镜像文件&quot;">​</a></h3><p>KubeVirt 可以使用 PVC 作为后端磁盘，使用 <code>filesystem</code> 类型的 PVC 时，默认使用的时 <code>/disk.img</code> 这个镜像，用户可以将镜像上传到 PVC， 在创建 VMI 时使用此 PVC。使用这种方式需要注意下面几点：</p><ul><li>一个 PVC 只允许存在一个镜像，只允许一个 VMI 使用，要创建多个 VMI，需要上传多次</li><li><code>/disk.img</code> 的格式必须是 RAW 格式</li></ul><p>CDI 提供了使用使用 PVC 作为虚拟机磁盘的方案，在虚拟机启动前通过下面方式填充 PVC：</p><ul><li>通过 URL 导入虚拟机镜像到 PVC，URL 可以是 http 链接，s3 链接</li><li>Clone 一个已经存在的 PVC</li><li>通过 container registry 导入虚拟机磁盘到 PVC，需要结合 <code>ContainerDisk</code> 使用</li><li>通过客户端上传本地镜像到 PVC</li></ul><p>通过命令行 <code>virtctl</code>，结合 CDI 项目，可以上传本地镜像到 PVC 上，支持的镜像格式有：</p><ul><li><code>.img</code></li><li><code>.qcow2</code></li><li><code>.iso</code></li><li>压缩为 <code>.tar</code>，<code>.gz</code>，<code>.xz</code> 格式的上述镜像</li></ul><p>上传镜像文件</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  export CDI_PROXY=\`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cdi get svc -l cdi.kubevirt.io=cdi-uploadproxy -o go-template --template=&#39;{{ (index .items 0).spec.clusterIP }}&#39;\`</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> virtctl image-upload --image-path=&#39;/root/iso/CentOS-7-x86_64-DVD-2009.iso&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --pvc-name=iso-centos7</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --pvc-size=5G</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --uploadproxy-url=https://</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$CDI_PROXY</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --insecure</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --wait-secs=240</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PVC</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default/iso-centos7 not found</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PersistentVolumeClaim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default/iso-centos7 created</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Waiting</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> for PVC iso-centos7 upload pod to be ready...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Pod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> now ready</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Uploading</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> data to https://10.98.254.51</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 4.39</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GiB / </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.39</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GiB [=============================================================================================================================================================] </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100.00</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">% </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m43s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Uploading</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> data completed successfully, waiting for processing to complete, you can hit ctrl-c without interrupting the progress</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Processing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> completed successfully</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Uploading</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /root/iso/CentOS-7-x86_64-DVD-2009.iso completed successfully</span></span></code></pre></div><p>参数说明：</p><ul><li><code>–image-path</code> : 操作系统镜像路径。</li><li><code>–pvc-name</code> : 指定存储操作系统镜像的 PVC，这个 PVC 不需要提前准备好，镜像上传过程中会自动创建。</li><li><code>–pvc-size</code> : PVC 大小，根据操作系统镜像大小来设定，一般略大一个 G 就行。</li><li><code>–uploadproxy-url</code> : <code>cdi-uploadproxy</code> 的 Service IP，可以通过命令 <code>kubectl -n cdi get svc -l cdi.kubevirt.io=cdi-uploadproxy</code> 来查看。</li></ul><h3 id="启动hostdisk特性门控" tabindex="-1">启动HostDisk特性门控 <a class="header-anchor" href="#启动hostdisk特性门控" aria-label="Permalink to &quot;启动HostDisk特性门控&quot;">​</a></h3><p>kubeVirt支持<code>HostDisk</code></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl edit kubevirt kubevirt -n kubevirt</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    spec:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      configuration:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        developerConfiguration:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          featureGates:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DataVolumes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> HostDisk</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ...</span></span></code></pre></div><h3 id="编排centos7虚拟机模板文件" tabindex="-1">编排CentOS7虚拟机模板文件 <a class="header-anchor" href="#编排centos7虚拟机模板文件" aria-label="Permalink to &quot;编排CentOS7虚拟机模板文件&quot;">​</a></h3><details class="details custom-block"><summary><code>kubevirt-centos7.yaml</code></summary><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubevirt.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">VirtualMachine</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">centos7</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  running</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        kubevirt.io/domain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">centos7</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      domain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          cores</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        devices</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          disks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">bootOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            cdrom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              bus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">sata</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cdromiso</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">disk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              bus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">virtio</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">harddrive</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">cdrom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              bus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">sata</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">virtiocontainerdisk</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          interfaces</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">masquerade</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        machine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">q35</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        resources</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          requests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">2G</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      networks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        pod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cdromiso</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        persistentVolumeClaim</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          claimName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">iso-centos7</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">harddrive</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        hostDisk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          capacity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">30Gi</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/data/disk.img</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">DiskOrCreate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">containerDisk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubevirt/virtio-container-disk</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">virtiocontainerdisk</span></span></code></pre></div></details><p>这里用到了 3 个 Volume：</p><ul><li><code>cdromiso</code> : 提供操作系统安装镜像，即上文上传镜像后生成的 PVC iso-centos7。</li><li><code>harddrive</code> : 虚拟机使用的磁盘，即操作系统就会安装在该磁盘上。这里选择 <code>hostDisk</code> 直接挂载到宿主机以提升性能，如果使用分布式存储则体验非常不好。</li><li><code>containerDisk</code> : 由于 Windows 默认无法识别 <code>raw</code> 格式的磁盘，所以需要安装 <code>virtio</code> 驱动。 <code>containerDisk</code> 可以将打包好 <code>virtio</code> 驱动的容器镜像挂载到虚拟机中。</li></ul><p>关于网络部分，<code>spec.template.spec.networks</code> 定义了一个网络叫 <code>default</code>，这里表示使用 Kubernetes 默认的 CNI。<code>spec.template.spec.domain.devices.interfaces</code> 选择定义的 网络 <code>default</code>，并开启 <code>masquerade</code>，以使用网络地址转换 (NAT) 来通过 Linux 网桥将虚拟机连接至 Pod 网络后端。</p><p>编排模板文件，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply -f kubevirt-centos7.yaml</span></span></code></pre></div><h3 id="启动虚拟机和vnc代理" tabindex="-1">启动虚拟机和vnc代理 <a class="header-anchor" href="#启动虚拟机和vnc代理" aria-label="Permalink to &quot;启动虚拟机和vnc代理&quot;">​</a></h3><p>启动虚拟机，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virtctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start centos7</span></span></code></pre></div><p>启动vnc代理，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> virtctl vnc centos7 --proxy-only --address=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.0.0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;port&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:42743}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;component&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;level&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;info&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;msg&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;connection timeout: 1m0s&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;pos&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;vnc.go:153&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;timestamp&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;2022-06-07T10:06:11.066704Z&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;component&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;level&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;info&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;msg&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;VNC Client connected in 7.866330333s&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;pos&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;vnc.go:166&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;timestamp&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;2022-06-07T10:06:18.933070Z&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">}</span></span></code></pre></div><p>执行完上面的命令后，就会打开本地的 VNC 客户端连接到虚拟机，</p><p><img src="https://cdn.jsdelivr.net/gh/hyperter96/cloud-native-docs/docs/assets/images/centos7-vnc.png" alt="" loading="lazy"></p><p>直接下一步直到完成即可。安装完成重启后虚拟机依旧会从 <code>cdrom</code> 启动，修改 vm，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virtctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop centos7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> edit virtualmachine.kubevirt.io/centos7</span></span></code></pre></div><p>设硬盘为第一启动项，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        devices:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          disks:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bootOrder: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            cdrom:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">              bus:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sata</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cdromiso</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bootOrder: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            disk:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">              bus:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> virtio</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> harddrive</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span></code></pre></div><p>修改完成，重启虚拟机</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">virtctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start centos7</span></span></code></pre></div><p>centOS7 虚拟机启动正常。</p><p><img src="https://cdn.jsdelivr.net/gh/hyperter96/tech-blog/docs/assets/images/centos7-start.png" alt="" loading="lazy"></p>`,57),l=[t];function p(k,e,r,d,F,g){return i(),a("div",null,l)}const y=s(h,[["render",p]]);export{c as __pageData,y as default};
