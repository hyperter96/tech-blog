import{j as s,b as i,c as a,aa as n}from"./chunks/framework._Kr-eMMD.js";const c=JSON.parse('{"title":"Cilium系列二：使用bird和cilium部署BGP模式的k8s集群","description":"","frontmatter":{"sidebar":false,"cover":"https://cdn.jsdelivr.net/gh/hyperter96/tech-blog/docs/assets/images/cilium-bgp-demo.svg","date":"2024-02-05T00:00:00.000Z","tag":["Cilium","网络","cni","kubernetes"],"sticky":1,"prev":{"text":"Cilium系列一：Cilium架构体系","link":"/posts/cilium/cilium-intro"},"next":{"text":"Cilium系列三：Cilium在集群网格Cluster Mesh中的实践","link":"/posts/cilium/exercise-cluster-mesh"},"head":[]},"headers":[],"relativePath":"posts/cilium/bgp-exercise-bird-cilium.md","filePath":"posts/cilium/bgp-exercise-bird-cilium.md","lastUpdated":1712408366000}'),l={name:"posts/cilium/bgp-exercise-bird-cilium.md"},p=n(`<h1 id="cilium系列二-使用bird和cilium部署bgp模式的k8s集群" tabindex="-1">Cilium系列二：使用bird和cilium部署BGP模式的k8s集群 <a class="header-anchor" href="#cilium系列二-使用bird和cilium部署bgp模式的k8s集群" aria-label="Permalink to &quot;Cilium系列二：使用bird和cilium部署BGP模式的k8s集群&quot;">​</a></h1><p>这是使用 Cilium BGP 控制平面 (BGP CP) 向外部 BGP 路由器通告路由以及在两个集群之间路由的演示。 每个集群执行以下操作：</p><ol><li>运行 2 个作为部署进行管理的 nginx pod。</li><li>将 nginx pod 作为服务公开。</li><li>使用 Cilium IP 池将外部 IP 分配给服务。</li><li>使用 BGP CP 通告 nginx 服务。</li></ol><h2 id="前置条件" tabindex="-1">前置条件 <a class="header-anchor" href="#前置条件" aria-label="Permalink to &quot;前置条件&quot;">​</a></h2><ol><li><code>kubectl</code></li><li><code>helm</code></li><li><code>kind</code></li><li><code>cilium-cli</code></li></ol><h2 id="安装集群" tabindex="-1">安装集群 <a class="header-anchor" href="#安装集群" aria-label="Permalink to &quot;安装集群&quot;">​</a></h2><p>使用<code>kind</code>安装第一个集群，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cluster</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kind: Cluster</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apiVersion: kind.x-k8s.io/v1alpha4</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">networking:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  disableDefaultCNI: true   # do not install kindnet</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  kubeProxyMode: none       # do not run kube-proxy</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  podSubnet: &quot;10.241.0.0/16&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  serviceSubnet: &quot;10.11.0.0/16&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">name: cilium</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">nodes:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">- role: control-plane</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">- role: worker</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">- role: worker</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">注意</p><p>使用两个工作节点，因此 nginx 部署中的每个 pod 都被安排到一个单独的节点。</p></div><p>创建用于第二个集群的 Docker 网络：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> network</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d=bridge</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;com.docker.network.bridge.enable_ip_masquerade=true&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    --attachable</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;kind2&quot;</span></span></code></pre></div><p>设置 <code>KIND_EXPERIMENTAL_DOCKER_NETWORK</code> 环境变量，让 <code>kind</code> 使用此网络而不是默认的 <code>kind</code> 网络：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KIND_EXPERIMENTAL_DOCKER_NETWORK</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kind2</span></span></code></pre></div><p>创建第二个集群，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cluster</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kind: Cluster</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apiVersion: kind.x-k8s.io/v1alpha4</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">networking:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  disableDefaultCNI: true   # do not install kindnet</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  kubeProxyMode: none       # do not run kube-proxy</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  podSubnet: &quot;10.242.0.0/16&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  serviceSubnet: &quot;10.12.0.0/16&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">name: cilium2</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">nodes:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">- role: control-plane</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">- role: worker</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">- role: worker</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div><p>删除环境变量，以便将来的集群安装使用默认类型的 Docker 网络。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unset</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> KIND_EXPERIMENTAL_DOCKER_NETWORK</span></span></code></pre></div><p>您现在有两个不同网络的 k8s 集群，且暂时无法相互通信。两个集群的节点信息如下，</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-0cJ5D" id="tab-Tj2ECZg" checked="checked"><label for="tab-Tj2ECZg">kind-cilium2</label><input type="radio" name="group-0cJ5D" id="tab-X_fEtbH"><label for="tab-X_fEtbH">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nodes</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> wide</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                    STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ROLES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    VERSION</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   INTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   OS-IMAGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                         KERNEL-VERSION</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                        CONTAINER-RUNTIME</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium2-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   2d5h</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   v1.27.3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   172.19.0.4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        Debian</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GNU/Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (bullseye)   5.15.133.1-microsoft-standard-WSL2+   containerd://1.7.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium2-worker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    svr</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             2d5h</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   v1.27.3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   172.19.0.3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        Debian</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GNU/Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (bullseye)   5.15.133.1-microsoft-standard-WSL2+   containerd://1.7.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium2-worker2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         Ready</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          2d5h</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   v1.27.3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   172.19.0.2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        Debian</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GNU/Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (bullseye)   5.15.133.1-microsoft-standard-WSL2+   containerd://1.7.1</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nodes</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> wide</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                   STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ROLES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    VERSION</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   INTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   OS-IMAGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                         KERNEL-VERSION</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                        CONTAINER-RUNTIME</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   2d5h</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   v1.27.3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   172.18.0.2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        Debian</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GNU/Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (bullseye)   5.15.133.1-microsoft-standard-WSL2+   containerd://1.7.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-worker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          Ready</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          2d5h</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   v1.27.3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   172.18.0.3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        Debian</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GNU/Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (bullseye)   5.15.133.1-microsoft-standard-WSL2+   containerd://1.7.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-worker2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         Ready</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          2d5h</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   v1.27.3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   172.18.0.4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        Debian</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GNU/Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (bullseye)   5.15.133.1-microsoft-standard-WSL2+   containerd://1.7.1</span></span></code></pre></div></div></div><h2 id="安装cilium" tabindex="-1">安装Cilium <a class="header-anchor" href="#安装cilium" aria-label="Permalink to &quot;安装Cilium&quot;">​</a></h2><p>在第二个集群中安装 <code>Cilium v1.14</code>。 Kind 应该为 <code>kind-cilium2</code> 的 <code>context</code> 设置 <code>kubectl context</code>。 在本指南中使用 <code>kubectl config use-context</code> 命令在 <code>kind-cilium</code> 和 <code>kind-cilium2</code> 的 <code>context</code> 之间进行更改，例如 <code>cilium</code> 和 <code>cilium 2</code> 集群。</p><div class="warning custom-block"><p class="custom-block-title">注意</p><p>如果这是第一次使用 <code>Helm</code> 安装 <code>Cilium</code>，请使用 <code>install</code> 子命令而不是 <code>upgrade</code>。</p></div><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-bXt8D" id="tab-Gtfj2Qp" checked="checked"><label for="tab-Gtfj2Qp">kind-cilium2</label><input type="radio" name="group-bXt8D" id="tab-lyofvwQ"><label for="tab-lyofvwQ">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --kube-context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium/cilium</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --version</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.14.0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --values</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubeProxyReplacement: strict</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">k8sServiceHost: cilium2-control-plane # use master node in kind network</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">k8sServicePort: 6443               # use api server port</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">hostServices:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  enabled: false</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">externalIPs:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  enabled: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">nodePort:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  enabled: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">hostPort:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  enabled: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">image:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  pullPolicy: IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ipam:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  mode: kubernetes</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">tunnel: disabled</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ipv4NativeRoutingCIDR: 10.11.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bgpControlPlane:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  enabled: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">autoDirectNodeRoutes: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --kube-context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium/cilium</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --version</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.14.0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --values</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubeProxyReplacement: strict</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">k8sServiceHost: cilium-control-plane # use master node in kind network</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">k8sServicePort: 6443               # use api server port</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">hostServices:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  enabled: false</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">externalIPs:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  enabled: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">nodePort:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  enabled: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">hostPort:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  enabled: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">image:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  pullPolicy: IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ipam:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  mode: kubernetes</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">tunnel: disabled</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ipv4NativeRoutingCIDR: 10.12.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bgpControlPlane:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  enabled: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">autoDirectNodeRoutes: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div></div></div><p>等待cilium安装成功，</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-adLXe" id="tab-R-UcB6F" checked="checked"><label for="tab-R-UcB6F">kind-cilium2</label><input type="radio" name="group-adLXe" id="tab-E4NEIhE"><label for="tab-E4NEIhE">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --wait</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    /¯¯\\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_/¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Cilium:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Operator:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> /¯¯\\__/¯¯\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Envoy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DaemonSet:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    disabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (using </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">embedded</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Hubble</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Relay:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       disabled</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    \\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       ClusterMesh:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        disabled</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DaemonSet</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">              cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             Desired:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ready:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2/2,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Available:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2/2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Desired:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ready:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2/2,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Available:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2/2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Containers:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Running:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                       cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             Running:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Pods:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          3/3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> managed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> by</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Cilium</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> version:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1.14.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Image</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> versions</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             quay.io/cilium/cilium:v1.14.0@sha256:5a94b561f4651fcfd85970a50bc78b201cfbd6e2ab1a03848eab25a82832653a:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                       cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    quay.io/cilium/operator-generic:v1.14.0@sha256:3014d4bcb8352f0ddef90fa3b5eb1bbf179b91024813a90a0066eb4517ba93c9:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --wait</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    /¯¯\\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_/¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Cilium:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Operator:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> /¯¯\\__/¯¯\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Envoy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DaemonSet:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    disabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (using </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">embedded</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Hubble</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Relay:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       disabled</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    \\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       ClusterMesh:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        disabled</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Desired:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ready:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2/2,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Available:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2/2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DaemonSet</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">              cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             Desired:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ready:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2/2,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Available:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2/2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Containers:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             Running:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                       cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Running:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Pods:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          3/3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> managed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> by</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Cilium</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> version:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1.14.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Image</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> versions</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             quay.io/cilium/cilium:v1.14.0@sha256:5a94b561f4651fcfd85970a50bc78b201cfbd6e2ab1a03848eab25a82832653a:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                       cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    quay.io/cilium/operator-generic:v1.14.0@sha256:3014d4bcb8352f0ddef90fa3b5eb1bbf179b91024813a90a0066eb4517ba93c9:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span></code></pre></div></div></div><h2 id="运行外部bgp路由" tabindex="-1">运行外部BGP路由 <a class="header-anchor" href="#运行外部bgp路由" aria-label="Permalink to &quot;运行外部BGP路由&quot;">​</a></h2><p>我们使用 Bird 作为外部路由器，并与每个集群中的 Cilium BGP 路由器对等。<code>bird.conf</code>的配置如下，</p><details class="details custom-block"><summary><code>bird.conf</code></summary><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>log &quot;bird.log&quot; all;</span></span>
<span class="line"><span># debug protocols all;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>protocol device {</span></span>
<span class="line"><span>    scan time 10;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># BGP peer cilium-control-plane node config</span></span>
<span class="line"><span>protocol bgp cluster1_cp {</span></span>
<span class="line"><span>    # IP of Bird container interface to kind-cilium cluster</span></span>
<span class="line"><span>    router id 172.18.0.5;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ipv4 {</span></span>
<span class="line"><span>        import all;</span></span>
<span class="line"><span>        export all;</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Local settings (Assuming AS 65000 for our BIRD instance)</span></span>
<span class="line"><span>    local as 65000;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Peer cilium-control-plane node</span></span>
<span class="line"><span>    neighbor 172.18.0.2 as 65100;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># BGP peer cilium-worker node config</span></span>
<span class="line"><span>protocol bgp cluster1_worker {</span></span>
<span class="line"><span>    # IP of Bird container interface to kind-cilium cluster</span></span>
<span class="line"><span>    router id 172.18.0.5; # eth0 IP of Bird container</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ipv4 {</span></span>
<span class="line"><span>        import all;</span></span>
<span class="line"><span>        export all;</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Local settings (Assuming AS 65000 for our BIRD instance)</span></span>
<span class="line"><span>    local as 65000;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Peer cilium-worker node</span></span>
<span class="line"><span>    neighbor 172.18.0.3 as 65100;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># BGP peer cilium-worker2 node config</span></span>
<span class="line"><span>protocol bgp cluster1_worker2 {</span></span>
<span class="line"><span>    # IP of Bird container interface to kind-cilium cluster</span></span>
<span class="line"><span>    router id 172.18.0.5;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ipv4 {</span></span>
<span class="line"><span>        import all;</span></span>
<span class="line"><span>        export all;</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Local settings (Assuming AS 65000 for our BIRD instance)</span></span>
<span class="line"><span>    local as 65000;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Peer cilium-worker2 node</span></span>
<span class="line"><span>    neighbor 172.18.0.4 as 65100;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># BGP peer cilium2-control-plane node config</span></span>
<span class="line"><span>protocol bgp cluster2_cp {</span></span>
<span class="line"><span>    # IP of Bird container interface to kind-cilium2 cluster</span></span>
<span class="line"><span>    router id 172.19.0.5;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ipv4 {</span></span>
<span class="line"><span>        import all;</span></span>
<span class="line"><span>        export all;</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Local settings (Assuming AS 65000 for our BIRD instance)</span></span>
<span class="line"><span>    local as 65000;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Peer cilium2-control-plane node</span></span>
<span class="line"><span>    neighbor 172.19.0.4 as 65200;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># BGP peer cilium2-worker node config</span></span>
<span class="line"><span>protocol bgp cluster2_worker {</span></span>
<span class="line"><span>    # IP of Bird container interface to kind-cilium2 cluster</span></span>
<span class="line"><span>    router id 172.19.0.5;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ipv4 {</span></span>
<span class="line"><span>        import all;</span></span>
<span class="line"><span>        export all;</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Local settings (Assuming AS 65000 for our BIRD instance)</span></span>
<span class="line"><span>    local as 65000;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Peer cilium2-worker node</span></span>
<span class="line"><span>    neighbor 172.19.0.3 as 65200;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># BGP peer cilium2-worker2 node config</span></span>
<span class="line"><span>protocol bgp cluster2_worker2 {</span></span>
<span class="line"><span>    # IP of Bird container interface to kind-cilium2 cluster</span></span>
<span class="line"><span>    router id 172.19.0.5;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ipv4 {</span></span>
<span class="line"><span>        import all;</span></span>
<span class="line"><span>        export all;</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Local settings (Assuming AS 65000 for our BIRD instance)</span></span>
<span class="line"><span>    local as 65000;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # Peer cilium-worker2 node</span></span>
<span class="line"><span>    neighbor 172.19.0.2 as 65200;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Direct routes</span></span>
<span class="line"><span>protocol direct {</span></span>
<span class="line"><span>    interface &quot;eth*&quot;, &quot;lo&quot;;  # Listen to these interfaces for direct routes</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># This protocol manages kernel route table</span></span>
<span class="line"><span>protocol kernel {</span></span>
<span class="line"><span>    learn;          # Learn existing routes from kernel</span></span>
<span class="line"><span>    persist;        # Don&#39;t remove routes on BIRD shutdown</span></span>
<span class="line"><span>    scan time 20;   # Scan kernel routing table every 20 seconds</span></span>
<span class="line"><span>    ipv4 {</span></span>
<span class="line"><span>        export all;     # Default is export none</span></span>
<span class="line"><span>        import none;    # Default is import all</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span>}</span></span></code></pre></div></details><p>拉取 <code>bird</code> 的镜像，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pull</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ghcr.io/akafeng/bird</span></span></code></pre></div><p>启动 <code>bird-router</code>的容器，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> $(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pwd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">):/etc/bird/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --cap-add=NET_ADMIN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --network=kind</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --name=bird-router</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ghcr.io/akafeng/bird</span></span></code></pre></div><p>待容器启动以后，进入容器，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bird-router</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sh</span></span></code></pre></div><p>重新加载 <code>bird</code> 的配置，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">birdc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configure</span></span></code></pre></div><p>验证网络接口配置和路由表：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> addr</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> list</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span></span></code></pre></div><p>验证 BGP 配置。</p><div class="warning custom-block"><p class="custom-block-title">注意</p><p>在为两个集群配置 Cilium BGP CP 之前，配置的对等点不会 <code>ESTABLISHED</code>。</p></div><h2 id="运行-nginx-sample-应用" tabindex="-1">运行 nginx sample 应用 <a class="header-anchor" href="#运行-nginx-sample-应用" aria-label="Permalink to &quot;运行 nginx sample 应用&quot;">​</a></h2><p>两个集群同时创建 nginx 应用，</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-qHK1b" id="tab-zrGz89U" checked="checked"><label for="tab-zrGz89U">kind-cilium2</label><input type="radio" name="group-qHK1b" id="tab-EfZrHhC"><label for="tab-EfZrHhC">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apiVersion: apps/v1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kind: Deployment</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  name: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">spec:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  selector:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    matchLabels:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      app: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  replicas: 2</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  template:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    metadata:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      labels:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        app: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    spec:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      containers:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      - name: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        image: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        ports:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        - containerPort: 80</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apiVersion: apps/v1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kind: Deployment</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  name: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">spec:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  selector:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    matchLabels:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      app: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  replicas: 2</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  template:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    metadata:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      labels:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        app: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    spec:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      containers:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      - name: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        image: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        ports:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        - containerPort: 80</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div></div></div><p>各获取 nginx Pod 的IP，</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-Fv0vq" id="tab-oearVEr" checked="checked"><label for="tab-oearVEr">kind-cilium2</label><input type="radio" name="group-Fv0vq" id="tab-CXB7pXH"><label for="tab-CXB7pXH">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> wide</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nginx-55f598f8d-76knw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          39h</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.242.2.61</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    cilium2-worker</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">           &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nginx-55f598f8d-lttxc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          39h</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.242.1.251</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   cilium2-worker2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">           &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> wide</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nginx-55f598f8d-mxcw6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          39h</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.241.1.140</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   cilium-worker</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">           &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nginx-55f598f8d-xd4t8</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          39h</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.241.2.19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    cilium-worker2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">           &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div></div></div><p>同一个集群下，测试两个nginx是否连通，</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-iuixL" id="tab-0tXbzMg" checked="checked"><label for="tab-0tXbzMg">kind-cilium2</label><input type="radio" name="group-iuixL" id="tab-6BAuYyC"><label for="tab-6BAuYyC">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/nginx-55f598f8d-76knw</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/null</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -w</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;%{http_code}&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://10.242.1.251</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">200</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/nginx-55f598f8d-mxcw6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/null</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -w</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;%{http_code}&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://10.241.2.19</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">200</span></span></code></pre></div></div></div><p>每个集群内的连接已成功验证，您现在可以继续下一部分。</p><p>使用负载均衡器服务公开每个集群的 nginx 部署。 首先创建用于向负载均衡器服务分配地址的 IPAM 池：</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-VBiKx" id="tab-6mPj5ks" checked="checked"><label for="tab-6mPj5ks">kind-cilium2</label><input type="radio" name="group-VBiKx" id="tab-_F9Vjup"><label for="tab-_F9Vjup">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apiVersion: &quot;cilium.io/v2alpha1&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kind: CiliumLoadBalancerIPPool</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  name: demo</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">spec:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  cidrs:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  - cidr: &quot;10.12.0.0/16&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apiVersion: &quot;cilium.io/v2alpha1&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kind: CiliumLoadBalancerIPPool</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  name: demo</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">spec:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  cidrs:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  - cidr: &quot;10.11.0.0/16&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div></div></div><p>并暴露 nginx 服务，</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-n-q9C" id="tab-HWi7X_w" checked="checked"><label for="tab-HWi7X_w">kind-cilium2</label><input type="radio" name="group-n-q9C" id="tab-H97qe7i"><label for="tab-H97qe7i">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> expose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --type=LoadBalancer</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --port=80</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --labels</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app=nginx</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> expose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --type=LoadBalancer</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --port=80</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --labels</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app=nginx</span></span></code></pre></div></div></div><p>每个集群的 nginx 服务都应该有一个从 IPAM 池分配的外部 IP。 检查两个集群中nginx服务的外部IP，</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-5Rwj1" id="tab-z-cQclu" checked="checked"><label for="tab-z-cQclu">kind-cilium2</label><input type="radio" name="group-5Rwj1" id="tab-W_0g3Un"><label for="tab-W_0g3Un">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> svc/nginx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    TYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           CLUSTER-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)        </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nginx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   LoadBalancer</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.12.173.3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.12.225.247</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   80:32313/TCP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   39h</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> svc/nginx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    TYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           CLUSTER-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)        </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nginx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   LoadBalancer</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.11.144.48</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.11.192.248</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   80:32047/TCP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   39h</span></span></code></pre></div></div></div><p>在接下来的步骤中，BGP 将公布外部 IP，以提供负载均衡器服务的外部/集群间连接。</p><h2 id="配置-bgp" tabindex="-1">配置 BGP <a class="header-anchor" href="#配置-bgp" aria-label="Permalink to &quot;配置 BGP&quot;">​</a></h2><p>Cilium BGP 配置分为两部分：</p><ol><li>注释将运行 BGP 的节点并配置对等策略以配置 BGP 对端</li><li>通告路由等。</li></ol><p>有关 BGP 控制平面的其他详细信息，请参阅<a href="https://docs.cilium.io/en/v1.14/network/bgp-control-plane/" target="_blank" rel="noreferrer">官方文档</a>。</p><p>注释两个集群的节点，</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-Eq2wJ" id="tab-Ix7MXFg" checked="checked"><label for="tab-Ix7MXFg">kind-cilium2</label><input type="radio" name="group-Eq2wJ" id="tab-bmO3qi0"><label for="tab-bmO3qi0">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node/cilium2-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium.io/bgp-virtual-router.65200=&quot;local-port=179&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node/cilium2-worker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium.io/bgp-virtual-router.65200=&quot;local-port=179&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node/cilium2-worker2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium.io/bgp-virtual-router.65200=&quot;local-port=179&quot;</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node/cilium-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium.io/bgp-virtual-router.65100=&quot;local-port=179&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node/cilium-worker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium.io/bgp-virtual-router.65100=&quot;local-port=179&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node/cilium-worker2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium.io/bgp-virtual-router.65100=&quot;local-port=179&quot;</span></span></code></pre></div></div></div><div class="warning custom-block"><p class="custom-block-title">注意</p><p>在典型部署中，BGP CP 将不会在控制平面节点上运行，因为它们不运行工作负载 Pod。</p></div><p>由于在此演示中每个集群都处于单独管理之下，因此使用了不同的自治系统 (AS) 编号，分别为 65100 和 65200。</p><p>将 BGP peer policy 应用于两个集群，</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-QaCoH" id="tab-SUXoQKw" checked="checked"><label for="tab-SUXoQKw">kind-cilium2</label><input type="radio" name="group-QaCoH" id="tab-3yLFnLb"><label for="tab-3yLFnLb">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apiVersion: cilium.io/v2alpha1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kind: CiliumBGPPeeringPolicy</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  name: demo</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">spec:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  nodeSelector:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    matchLabels:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      kubernetes.io/os: linux</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  virtualRouters:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    - exportPodCIDR: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      localASN: 65200</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      neighbors:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        - peerASN: 65000</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          peerAddress: 172.19.0.5/32 # eth1 IP of Bird router</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      serviceSelector:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        matchLabels:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          app: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apiVersion: cilium.io/v2alpha1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kind: CiliumBGPPeeringPolicy</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  name: demo</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">spec:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  nodeSelector:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    matchLabels:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      kubernetes.io/os: linux</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  virtualRouters:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    - exportPodCIDR: true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      localASN: 65100</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      neighbors:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        - peerASN: 65000</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          peerAddress: 172.18.0.5/32 # eth0 IP of Bird router</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      serviceSelector:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        matchLabels:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          app: nginx</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div></div></div><div class="warning custom-block"><p class="custom-block-title">注意</p><p><code>exportPodCIDR</code> 字段的设置是为了让节点通告 Pod CIDR。 这将允许外部 Bird 路由器将响应流量路由回 cURL 客户端。</p></div><p>由于 BGP CP 不会将路由添加到数据路径（即本地节点路由表），因此您必须在节点上创建到对方集群的 Service 和 Pod CIDR 的静态路由。</p><p>在两个集群中添加静态路由。 使用 <code>kubectl --context kind-cilium get po -n kube-system | grep cilium</code> 如果您需要 Cilium pod 的容器名称，</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-1NT3k" id="tab-fdj5nWD" checked="checked"><label for="tab-fdj5nWD">kind-cilium2</label><input type="radio" name="group-1NT3k" id="tab-OmR8p68"><label for="tab-OmR8p68">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-g7djj</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                    1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   49</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   2d5h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-jq5xr</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                    1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   49</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   2d5h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-operator-5c748d6d-5hnfx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                  1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    2d5h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-operator-5c748d6d-q8gsl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                  1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    2d5h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-sh6qh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                    1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   49</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   2d5h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">etcd-cilium2-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                      1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    2d6h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-apiserver-cilium2-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    2d6h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-controller-manager-cilium2-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    2d6h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-scheduler-cilium2-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    2d6h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-g7djj</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.11.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.19.0.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-g7djj</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.241.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.19.0.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-jq5xr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.11.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.19.0.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-jq5xr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.241.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.19.0.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-sh6qh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.11.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.19.0.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-sh6qh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.241.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.19.0.5</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-2kfdw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                   1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   49</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   2d5h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-88mkj</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                   1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   2d5h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-operator-5b5cc99864-nf657</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">               1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    2d5h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-operator-5b5cc99864-xtbgh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">               1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    2d5h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-vrcj9</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                   1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   2d5h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">etcd-cilium-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                      1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">               2d2h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-apiserver-cilium-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">               2d2h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-controller-manager-cilium-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    2d6h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-scheduler-cilium-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (2d2h </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ago</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    2d6h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-2kfdw</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.12.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-2kfdw</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.242.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-88mkj</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.12.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-88mkj</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.242.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-vrcj9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.12.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> po/cilium-vrcj9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.242.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.5</span></span></code></pre></div></div></div><h2 id="验证-bgp-路由连通两个集群" tabindex="-1">验证 BGP 路由连通两个集群 <a class="header-anchor" href="#验证-bgp-路由连通两个集群" aria-label="Permalink to &quot;验证 BGP 路由连通两个集群&quot;">​</a></h2><p>验证是否已使用 Bird 路由器建立了两个集群的 BGP speaker：</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-toN5B" id="tab-eUd0IK5" checked="checked"><label for="tab-eUd0IK5">kind-cilium2</label><input type="radio" name="group-toN5B" id="tab-ZRM8-5F"><label for="tab-ZRM8-5F">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bgp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> peers</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                    Local</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> AS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Peer</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> AS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Peer</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Address</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Session</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> State</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Uptime</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      Family</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         Received</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Advertised</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium2-control-plane</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   65200</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      65000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     172.19.0.5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     established</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     30h35m47s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ipv4/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   7</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                                                                        ipv6/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium2-worker</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          65200</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      65000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     172.19.0.5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     established</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     30h35m45s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ipv4/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   7</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                                                                        ipv6/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium2-worker2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         65200</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      65000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     172.19.0.5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     established</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     30h35m47s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ipv4/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                                                                        ipv6/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          0</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cilium</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bgp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> peers</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                   Local</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> AS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Peer</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> AS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Peer</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Address</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Session</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> State</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Uptime</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      Family</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         Received</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Advertised</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-control-plane</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   65100</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      65000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     172.18.0.5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     established</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     30h36m33s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ipv4/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                                                                       ipv6/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-worker</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          65100</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      65000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     172.18.0.5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     established</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     30h36m34s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ipv4/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   7</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                                                                       ipv6/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cilium-worker2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         65100</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      65000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     172.18.0.5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     established</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     30h36m31s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ipv4/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   7</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                                                                       ipv6/unicast</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          0</span></span></code></pre></div></div></div><p>进入 bird-router，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bird-router</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sh</span></span></code></pre></div><p>验证路由表已更新，</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">10.11.192.248</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bird</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metric</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">10.12.225.247</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.19.0.2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bird</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metric</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">10.241.0.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bird</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metric</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">10.241.1.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bird</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metric</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">10.241.2.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bird</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metric</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">10.242.0.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.19.0.4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bird</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metric</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">10.242.1.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.19.0.2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bird</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metric</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">10.242.2.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.19.0.3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bird</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metric</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">172.18.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> src</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.18.0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">172.19.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> src</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.19.0.5</span></span></code></pre></div><p>验证两个集群中的nginx服务是否连通，</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-tdTcB" id="tab-qjKSZiU" checked="checked"><label for="tab-qjKSZiU">kind-cilium2</label><input type="radio" name="group-tdTcB" id="tab-tEmgixM"><label for="tab-tEmgixM">kind-cilium</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/null</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -w</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;%{http_code}&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://10.12.225.247</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">200</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/null</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -w</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;%{http_code}&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://10.11.192.248</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">200</span></span></code></pre></div></div></div>`,78),h=[p];function k(t,e,F,d,r,g){return i(),a("div",null,h)}const y=s(l,[["render",k]]);export{c as __pageData,y as default};
